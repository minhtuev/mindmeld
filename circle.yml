machine:
  python:
    version: 3.6.0
  post:
    - pyenv global 3.6.0 3.5.1 3.4.4 2.7.12
  environment:
    _JAVA_OPTIONS: "-Xms512m -Xmx1024m"
dependencies:
  cache_directories:
    - ~/mindmeld-workbench3/.tox
  override:
    - pip install bleach==1.5.0
    - pip install -r dev-requirements.txt --extra-index-url=https://$PYPI_USER:$PYPI_PASSWORD@mindmeld.com/pypi -U
    - PIP_EXTRA_INDEX_URL=https://$PYPI_USER:$PYPI_PASSWORD@mindmeld.com/pypi tox --notest
  post:
    - wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.1.2.tar.gz
    - tar -xvf elasticsearch-5.1.2.tar.gz
    - elasticsearch-5.1.2/bin/elasticsearch: {background: true}
    # Make sure that Elasticsearch is up before running tests:
    - sleep 10 && wget --waitretry=5 --retry-connrefused -v http://127.0.0.1:9200/
test:
  pre:
    - while ! nc -z localhost 8000; do sleep 5; done;:
        timeout: 150
  override:
    - PIP_EXTRA_INDEX_URL=https://$PYPI_USER:$PYPI_PASSWORD@mindmeld.com/pypi tox
    # Disabling blueprint testing due to the changes in the dev center
    # - mmworkbench blueprint home_assistant
deployment:
  s3:
    branch: /(develop)|(staging)|(master)/
    commands:
      - MM_BRANCH=$CIRCLE_BRANCH bash scripts/upload_blueprint.sh -d `pwd`/tests/kwik_e_mart -b kwik_e_mart
